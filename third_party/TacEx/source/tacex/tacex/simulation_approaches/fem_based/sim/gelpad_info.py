import numpy as np
import trimesh
from uipc import builtin, view
from uipc.geometry import SimplicialComplex

def get_gelpad_info(mesh:SimplicialComplex):
    trimesh_mesh = trimesh.Trimesh(
        vertices=view(mesh.vertices().find(builtin.position)).reshape(-1, 3),
        faces=view(mesh.triangles().find(builtin.topo)).reshape(-1, 3)
    )
    trimesh_mesh.fix_normals()
    points = trimesh_mesh.vertices
    faces = trimesh_mesh.faces
    faces_norm = trimesh_mesh.face_normals

    mxz, miz = np.max(points[:, 2]), np.min(points[:, 2])
    faces_on_surface = []
    vertices_on_surface = []
    faces_on_bottom = []
    vertices_on_bottom = []
    for idx, norm in enumerate(faces_norm):
        # if np.dot(norm, [0, 0, 1]) > 0.99 and np.all(points[faces[idx]][:, 2] >= mxz-1e-4):
        if np.all(points[faces[idx]][:, 2] >= mxz-2e-3):
            faces_on_surface.append(faces[idx])
            vertices_on_surface.extend(faces[idx])
        if np.dot(norm, [0, 0, -1]) > 0.99 and np.all(points[faces[idx]][:, 2] <= miz+1e-4):
            faces_on_bottom.append(faces[idx])
            vertices_on_bottom.extend(faces[idx])
    vertices_on_surface = np.unique(vertices_on_surface)
    faces_on_surface = np.array(faces_on_surface)
    vertices_on_bottom = np.unique(vertices_on_bottom)
    faces_on_bottom = np.array(faces_on_bottom)

    mxx, mix, mxy, miy = np.max(points[:, 0]), np.min(points[:, 0]), np.max(points[:, 1]), np.min(points[:, 1])
    def typ(pts):
        return 1*(pts[0] == mxx) + 2*(pts[0] == mix) + 4*(pts[1] == mxy) + 8*(pts[1] == miy)
    vertices_idx_on_boundary = []
    for idx, pt in enumerate(points):
        if typ(pt) > 0:
            vertices_idx_on_boundary.append(idx)
    vertices_idx_on_boundary = np.array(vertices_idx_on_boundary).astype(np.int32)
    vertices_on_boundary = points[vertices_idx_on_boundary]

    vertices_id_all_to_boundary = np.zeros(points.shape[0])
    vertices_id_all_to_boundary[vertices_idx_on_boundary] = np.arange(vertices_idx_on_boundary.shape[0])

    faces_on_boundary = []
    for idx, face in enumerate(faces):
        check, new_pid = True, []
        t = typ(points[face[0]]) & typ(points[face[1]]) & typ(points[face[2]])
        if t == 0:
            continue
        for i in range(3):
            new_pid.append(face[i])
        if check:
            faces_on_boundary.append(new_pid)
    faces_on_boundary = np.array(faces_on_boundary).astype(np.int32)
    
    info = {
        'mesh': {
            'vertices': points,
            'faces': faces,
            'normals': faces_norm
        },
        'surface': {
            'ids': vertices_on_surface,
            'vertices': points[vertices_on_surface],
            'faces': faces_on_surface
        },
        'bottom': {
            'ids': vertices_on_bottom,
            'vertices': points[vertices_on_bottom],
            'faces': faces_on_bottom
        },
        'boundary': {
            'ids': vertices_idx_on_boundary,
            'vertices': vertices_on_boundary,
            'faces': faces_on_boundary,
            'id_map': vertices_id_all_to_boundary
        }
    }
    return info

# gelsight_mini
SURFACE_FACES = {
    'gsmini': np.array([[16, 26, 27], [16, 27, 28], [31, 33, 34], [36, 37, 38], [46, 47, 48], [46, 48, 50], [62, 63, 64], [62, 64, 65], [88, 90, 91], [33, 89, 93], [33, 93, 34], [94, 36, 38], [94, 38, 95], [113, 115, 116], [113, 116, 114], [26, 117, 27], [30, 29, 118], [30, 120, 119], [135, 50, 48], [135, 136, 50], [135, 48, 117], [135, 137, 136], [135, 116, 138], [139, 140, 137], [139, 138, 141], [139, 142, 140], [139, 137, 138], [139, 143, 142], [139, 141, 143], [144, 38, 145], [144, 145, 50], [47, 28, 27], [47, 27, 48], [158, 66, 65], [158, 118, 66], [158, 65, 64], [158, 143, 141], [158, 64, 143], [158, 141, 120], [159, 35, 34], [159, 63, 35], [159, 160, 142], [159, 93, 160], [159, 142, 143], [159, 143, 64], [159, 64, 63], [159, 34, 93], [66, 118, 29], [35, 31, 34], [89, 88, 91], [89, 160, 93], [89, 91, 160], [50, 136, 144], [50, 145, 46], [114, 117, 26], [114, 116, 117], [119, 115, 113], [119, 120, 115], [164, 91, 90], [164, 137, 140], [117, 116, 135], [37, 46, 145], [38, 144, 95], [38, 37, 145], [118, 120, 30], [90, 94, 95], [90, 95, 164], [160, 140, 142], [160, 91, 140], [138, 115, 141], [138, 137, 135], [138, 116, 115], [136, 164, 95], [136, 137, 164], [115, 120, 141], [91, 164, 140], [48, 27, 117], [95, 144, 136], [120, 118, 158]]),
    'xsensews': np.array([[108, 107, 241], [84, 82, 83], [71, 215, 316], [65, 248, 244], [143, 300, 75], [119, 114, 113], [107, 108, 106], [143, 75, 74], [154, 145, 147], [70, 183, 216], [113, 121, 103], [142, 247, 147], [120, 265, 121], [148, 82, 85], [73, 178, 13], [110, 111, 112], [103, 244, 104], [84, 110, 109], [109, 107, 106], [113, 115, 122], [106, 108, 115], [13, 43, 73], [59, 141, 310], [49, 241, 50], [84, 105, 82], [72, 240, 179], [84, 153, 110], [60, 144, 255], [74, 144, 143], [214, 300, 316], [111, 62, 268], [145, 142, 147], [184, 69, 271], [154, 249, 219], [247, 249, 147], [219, 249, 220], [120, 252, 68], [115, 113, 114], [103, 116, 113], [14, 13, 271], [66, 103, 262], [152, 259, 111], [185, 117, 104], [86, 149, 150], [84, 109, 106], [111, 110, 152], [110, 153, 154], [83, 153, 84], [120, 68, 265], [111, 259, 62], [217, 248, 218], [71, 240, 72], [107, 110, 112], [117, 116, 103], [176, 177, 175], [120, 121, 113], [82, 105, 119], [82, 118, 177], [146, 140, 142], [177, 85, 82], [111, 52, 51], [106, 115, 114], [148, 151, 140], [13, 184, 271], [184, 274, 69], [154, 64, 288], [64, 154, 219], [105, 114, 119], [105, 106, 114], [86, 140, 151], [117, 185, 177], [148, 83, 82], [145, 154, 153], [221, 249, 57], [70, 274, 183], [83, 148, 146], [140, 143, 144], [107, 109, 110], [145, 146, 142], [142, 140, 141], [147, 249, 154], [43, 277, 12], [183, 184, 175], [142, 256, 58], [86, 143, 140], [144, 60, 310], [63, 259, 152], [176, 149, 85], [67, 121, 265], [175, 177, 185], [148, 140, 146], [141, 144, 310], [116, 117, 118], [108, 241, 115], [149, 176, 179], [142, 58, 247], [179, 176, 175], [150, 149, 179], [86, 151, 149], [85, 177, 176], [85, 149, 151], [179, 240, 150], [86, 150, 240], [86, 240, 300], [178, 175, 13], [175, 184, 13], [50, 241, 107], [216, 248, 217], [83, 145, 153], [83, 146, 145], [117, 103, 104], [120, 113, 122], [185, 104, 183], [14, 277, 13], [218, 248, 65], [140, 144, 141], [116, 118, 119], [84, 106, 105], [110, 154, 152], [215, 214, 316], [117, 177, 118], [223, 241, 49], [85, 151, 148], [51, 112, 111], [220, 249, 221], [183, 175, 185], [179, 175, 178], [13, 277, 43], [119, 113, 116], [82, 119, 118], [240, 316, 300], [103, 66, 244], [244, 248, 104], [54, 252, 120], [122, 55, 54], [54, 120, 122], [53, 252, 54], [115, 241, 56], [121, 262, 103], [67, 262, 121], [141, 256, 142], [59, 256, 141], [57, 249, 247], [222, 241, 223], [222, 56, 241], [55, 122, 115], [115, 56, 55], [152, 288, 63], [154, 288, 152], [52, 268, 25], [111, 268, 52], [240, 71, 316], [76, 300, 214], [183, 274, 184], [75, 300, 76], [86, 300, 143], [50, 112, 51], [112, 50, 107], [178, 73, 72], [72, 179, 178], [183, 248, 216], [104, 248, 183], [61, 255, 74], [74, 255, 144]]),
    'gf225': np.array([[207, 206, 95], [300, 302, 273], [266, 158, 265], [153, 161, 77], [327, 326, 328], [178, 145, 54], [176, 177, 50], [300, 299, 301], [273, 260, 261], [313, 312, 311], [207, 95, 97], [140, 160, 138], [178, 54, 53], [152, 87, 85], [10, 11, 143], [327, 329, 293], [285, 152, 321], [153, 77, 80], [194, 195, 193], [211, 210, 212], [201, 188, 199], [97, 100, 207], [183, 182, 169], [187, 180, 188], [152, 285, 150], [324, 353, 326], [242, 250, 245], [291, 289, 325], [200, 202, 213], [261, 260, 253], [151, 89, 91], [275, 259, 274], [265, 158, 159], [184, 167, 165], [172, 364, 363], [211, 219, 209], [357, 163, 358], [328, 355, 330], [231, 351, 350], [169, 167, 183], [36, 38, 106], [147, 215, 40], [247, 251, 246], [210, 145, 186], [186, 178, 179], [201, 199, 200], [192, 193, 191], [273, 274, 260], [218, 219, 214], [38, 40, 215], [217, 147, 146], [322, 323, 321], [88, 152, 150], [123, 154, 256], [198, 204, 203], [196, 205, 204], [171, 182, 181], [151, 322, 320], [325, 289, 323], [330, 356, 332], [142, 255, 250], [126, 127, 155], [149, 91, 148], [264, 160, 153], [43, 46, 146], [327, 291, 325], [196, 194, 205], [332, 357, 334], [291, 327, 293], [264, 265, 159], [331, 295, 329], [292, 294, 269], [332, 334, 333], [183, 191, 190], [267, 266, 288], [157, 158, 266], [46, 45, 146], [264, 284, 265], [154, 155, 269], [161, 160, 140], [304, 274, 302], [153, 160, 161], [298, 297, 299], [233, 110, 112], [123, 124, 154], [159, 160, 264], [267, 268, 156], [250, 254, 249], [358, 336, 334], [302, 274, 273], [242, 245, 241], [301, 302, 300], [358, 162, 359], [298, 299, 300], [250, 249, 245], [278, 222, 221], [338, 339, 337], [203, 206, 202], [198, 200, 199], [330, 355, 356], [43, 146, 147], [43, 147, 41], [208, 146, 45], [67, 65, 228], [265, 286, 266], [178, 53, 51], [241, 120, 242], [75, 141, 73], [292, 290, 291], [265, 284, 286], [353, 354, 326], [352, 353, 324], [242, 120, 119], [149, 151, 91], [320, 152, 85], [140, 141, 161], [141, 75, 161], [153, 283, 264], [88, 87, 152], [284, 283, 150], [284, 264, 283], [75, 77, 161], [150, 285, 284], [284, 285, 286], [241, 115, 120], [191, 193, 195], [295, 293, 329], [157, 267, 156], [288, 289, 290], [266, 267, 157], [288, 290, 267], [286, 288, 266], [155, 268, 269], [155, 156, 268], [292, 269, 268], [268, 290, 292], [268, 267, 290], [292, 291, 293], [126, 457, 124], [328, 330, 329], [290, 289, 291], [155, 457, 126], [326, 325, 324], [294, 292, 293], [295, 294, 293], [163, 164, 162], [327, 328, 329], [327, 325, 326], [324, 323, 322], [325, 323, 324], [331, 329, 330], [332, 331, 330], [357, 332, 356], [197, 190, 195], [191, 195, 190], [285, 287, 286], [288, 287, 289], [288, 286, 287], [190, 189, 182], [203, 200, 198], [324, 322, 352], [355, 328, 354], [287, 323, 289], [328, 326, 354], [151, 352, 322], [320, 322, 321], [152, 320, 321], [287, 321, 323], [285, 321, 287], [92, 148, 91], [205, 194, 353], [353, 194, 354], [106, 38, 215], [352, 205, 353], [198, 196, 204], [169, 182, 171], [124, 457, 154], [200, 203, 202], [218, 217, 219], [154, 457, 155], [209, 219, 217], [175, 179, 177], [213, 202, 220], [209, 217, 146], [210, 208, 145], [214, 219, 220], [211, 220, 219], [211, 213, 220], [147, 40, 41], [192, 355, 193], [51, 50, 177], [147, 216, 215], [147, 217, 216], [217, 218, 216], [175, 180, 179], [209, 208, 210], [167, 169, 168], [104, 216, 218], [352, 149, 205], [112, 113, 144], [204, 149, 148], [241, 144, 115], [50, 55, 176], [205, 149, 204], [151, 149, 352], [220, 207, 214], [220, 202, 207], [35, 227, 34], [227, 35, 226], [202, 206, 207], [231, 350, 366], [133, 159, 134], [148, 206, 203], [209, 146, 208], [203, 204, 148], [180, 187, 179], [176, 55, 57], [176, 57, 366], [58, 366, 57], [216, 104, 102], [231, 63, 230], [178, 177, 179], [58, 60, 231], [213, 211, 212], [60, 63, 231], [213, 201, 200], [18, 20, 221], [18, 221, 222], [22, 222, 223], [211, 209, 210], [72, 32, 34], [22, 18, 222], [187, 201, 212], [186, 179, 187], [23, 22, 223], [174, 172, 173], [171, 181, 173], [187, 188, 201], [180, 181, 188], [180, 173, 181], [215, 101, 106], [173, 180, 175], [201, 213, 212], [145, 178, 186], [212, 210, 186], [187, 212, 186], [171, 170, 169], [345, 344, 346], [169, 170, 168], [196, 198, 197], [80, 79, 153], [355, 354, 193], [183, 190, 182], [1, 234, 7], [232, 7, 234], [235, 4, 232], [181, 182, 189], [181, 189, 188], [7, 232, 6], [194, 193, 354], [198, 199, 197], [199, 188, 189], [197, 189, 190], [197, 199, 189], [196, 197, 195], [356, 355, 192], [192, 191, 184], [300, 273, 272], [194, 196, 195], [183, 184, 191], [62, 68, 230], [167, 184, 183], [165, 164, 163], [319, 230, 68], [192, 184, 185], [192, 185, 356], [357, 356, 185], [163, 357, 185], [163, 185, 165], [184, 165, 185], [258, 276, 257], [336, 338, 337], [225, 281, 282], [246, 15, 13], [341, 343, 307], [300, 272, 298], [89, 151, 84], [295, 331, 297], [151, 320, 84], [162, 358, 163], [358, 359, 336], [226, 225, 282], [307, 309, 308], [363, 362, 170], [167, 168, 166], [320, 85, 84], [345, 343, 344], [168, 362, 361], [283, 153, 79], [342, 344, 343], [361, 340, 360], [174, 365, 364], [172, 174, 364], [137, 157, 131], [137, 158, 157], [341, 340, 342], [360, 164, 166], [361, 360, 166], [165, 166, 164], [165, 167, 166], [363, 170, 172], [318, 316, 317], [158, 137, 136], [175, 174, 173], [224, 27, 28], [278, 221, 277], [171, 173, 172], [170, 171, 172], [148, 92, 94], [72, 34, 227], [206, 148, 94], [175, 177, 176], [174, 175, 176], [206, 94, 95], [35, 30, 226], [319, 228, 318], [278, 312, 279], [101, 215, 216], [277, 257, 276], [276, 258, 275], [279, 312, 314], [21, 221, 20], [304, 306, 275], [276, 306, 308], [308, 306, 307], [276, 308, 277], [304, 275, 274], [362, 168, 170], [16, 15, 238], [275, 258, 259], [221, 257, 277], [145, 49, 48], [145, 208, 49], [316, 281, 280], [281, 225, 224], [208, 45, 49], [342, 340, 361], [350, 365, 366], [71, 227, 229], [71, 72, 227], [318, 228, 282], [113, 115, 144], [15, 246, 238], [176, 366, 365], [364, 348, 346], [227, 226, 229], [282, 229, 226], [313, 349, 315], [162, 164, 359], [224, 280, 281], [313, 314, 312], [339, 305, 303], [342, 362, 344], [224, 223, 280], [346, 344, 363], [347, 349, 313], [348, 365, 350], [341, 305, 339], [307, 305, 341], [253, 254, 261], [232, 236, 235], [301, 303, 302], [99, 105, 214], [105, 218, 214], [305, 304, 303], [271, 298, 272], [218, 105, 104], [294, 295, 296], [358, 334, 357], [238, 251, 258], [252, 259, 251], [247, 252, 251], [314, 280, 279], [99, 214, 100], [109, 110, 233], [207, 100, 214], [335, 336, 337], [82, 88, 150], [337, 301, 335], [83, 82, 150], [283, 83, 150], [230, 319, 317], [243, 237, 143], [332, 333, 331], [334, 336, 335], [247, 246, 237], [295, 297, 296], [333, 297, 331], [261, 254, 262], [283, 79, 83], [23, 223, 28], [271, 272, 262], [259, 252, 260], [274, 259, 260], [252, 247, 248], [359, 164, 360], [247, 237, 243], [302, 303, 304], [261, 262, 272], [25, 225, 29], [296, 270, 294], [30, 29, 226], [269, 270, 154], [238, 246, 251], [132, 156, 129], [127, 129, 156], [262, 263, 271], [250, 255, 254], [263, 262, 255], [269, 294, 270], [262, 254, 255], [102, 101, 216], [238, 258, 257], [248, 253, 252], [260, 252, 253], [256, 154, 263], [235, 239, 143], [301, 299, 335], [343, 341, 342], [143, 239, 243], [309, 310, 308], [335, 299, 333], [8, 10, 143], [107, 234, 1], [13, 237, 246], [8, 143, 237], [237, 13, 12], [232, 233, 236], [8, 237, 12], [236, 239, 235], [241, 240, 144], [270, 271, 263], [256, 121, 123], [138, 160, 133], [158, 136, 159], [160, 159, 133], [224, 25, 27], [134, 159, 136], [236, 233, 144], [298, 271, 296], [245, 240, 241], [69, 229, 64], [263, 255, 256], [319, 67, 228], [229, 228, 64], [131, 157, 132], [337, 303, 301], [234, 233, 232], [156, 132, 157], [343, 345, 309], [242, 119, 117], [248, 247, 243], [365, 174, 176], [168, 361, 166], [142, 242, 117], [334, 335, 333], [225, 226, 29], [25, 224, 225], [224, 28, 223], [11, 4, 235], [310, 278, 277], [142, 250, 242], [11, 235, 143], [308, 310, 277], [0, 107, 1], [233, 234, 109], [279, 223, 222], [236, 240, 239], [58, 231, 366], [244, 239, 240], [243, 239, 244], [253, 249, 254], [272, 273, 261], [244, 240, 245], [244, 248, 243], [249, 244, 245], [263, 154, 270], [248, 244, 249], [248, 249, 253], [236, 144, 240], [109, 234, 107], [307, 306, 305], [222, 278, 279], [305, 306, 304], [296, 297, 298], [333, 299, 297], [256, 255, 142], [296, 271, 270], [155, 127, 156], [281, 316, 318], [259, 258, 251], [275, 306, 276], [309, 345, 311], [307, 343, 309], [279, 280, 223], [62, 230, 63], [344, 362, 363], [257, 221, 21], [238, 21, 16], [257, 21, 238], [340, 338, 360], [340, 339, 338], [311, 345, 347], [144, 233, 112], [345, 346, 347], [342, 361, 362], [310, 312, 278], [311, 312, 310], [311, 310, 309], [231, 230, 351], [349, 351, 315], [347, 313, 311], [365, 348, 364], [315, 351, 317], [349, 350, 351], [339, 303, 337], [336, 359, 338], [338, 359, 360], [341, 339, 340], [348, 350, 349], [347, 346, 348], [117, 116, 142], [116, 121, 142], [121, 256, 142], [349, 347, 348], [364, 346, 363], [317, 351, 230], [229, 282, 228], [319, 318, 317], [229, 69, 71], [6, 232, 4], [281, 318, 282], [280, 314, 316], [315, 316, 314], [317, 316, 315], [315, 314, 313], [67, 319, 68], [65, 64, 228], [145, 48, 54], [178, 51, 177]])
}

CONSTRAIN_PTS = {
    'gsmini': np.array([0, 1, 3, 4, 5, 8, 9, 13, 14, 21, 24, 40, 41, 43, 44, 45, 51, 52, 53, 54, 58, 59, 60, 61, 67, 68, 69, 70, 71, 72, 73, 74, 77, 78, 79, 80, 82, 84, 85, 86, 87, 96, 99, 100, 101, 103, 104, 106, 107, 108, 110, 111, 112, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 161, 162, 163, 165]),
    'xsensews': np.array([0, 3, 6, 9, 15, 16, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 44, 77, 78, 79, 80, 81, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 100, 101, 102, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 180, 181, 182, 231, 239, 242, 245, 251, 254, 258, 261, 264, 267, 270, 273, 276, 279, 280, 281, 282, 283, 284, 285, 287, 289, 290, 291, 293, 294, 296, 297, 298, 299, 301, 302, 303, 304, 305, 306, 307, 308, 312, 313, 315, 317, 318, 319]),
    'gf225': np.array([2, 3, 5, 9, 14, 17, 19, 24, 26, 31, 33, 37, 39, 42, 44, 47, 52, 56, 59, 61, 66, 70, 74, 76, 78, 81, 86, 90, 93, 96, 98, 103, 108, 111, 114, 118, 122, 125, 128, 130, 135, 139, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456, 475, 476, 477, 479, 481, 482, 483, 484, 486, 487, 489, 490, 492, 494, 496, 497, 500, 502, 504, 505, 506, 507, 511])
}